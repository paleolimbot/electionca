select(province_code = provcode, riding = name) %>%
left_join(provinces, by = "province_code")
ridings_2003_raw %>%
select(province_code = provcode, riding = name) %>%
left_join(provinces, by = "province_code") %>%
filter(is.na(province))
ridings_2003_raw %>%
select(province_code = provcode, riding = name) %>%
left_join(provinces, by = "province_code") %>%
select(-province_code)
ridings_2003_raw %>%
select(province_code = provcode, riding = name) %>%
left_join(provinces, by = "province_code") %>%
select(province, riding)
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding = name) %>%
left_join(provinces, by = "province_code") %>%
select(province, riding)
ridings_check_all %>% filter(lubridate::year(election_date) > 2003, lubridate::year(election_date) < 2013)
ridings_check_2003 <- ridings_check_all %>%
filter(lubridate::year(election_date) > 2003, lubridate::year(election_date) < 2013)
ridings_check %>% anti_join(provinces)
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code")
ridings_check_2003 <- ridings_check_all %>%
filter(lubridate::year(election_date) > 2003, lubridate::year(election_date) < 2013)
ridings_check_2003 %>%
left_join(
ridings_2003 %>% st_set_geometry(NULL) %>% mutate(riding = str_to_upper(riding_label))
)
ridings_2003 %>% filter(str_detect(riding_label, "[Aa]thabasca"))
ridings_check_2003 %>%
left_join(
ridings_2003 %>% st_set_geometry(NULL) %>% mutate(riding = str_to_upper(riding_label))
) %>%
filter(is.na(riding_label))
ridings_check_2003 <- ridings_check_all %>%
filter(lubridate::year(election_date) > 2004, lubridate::year(election_date) < 2013)
ridings_check_2003 %>%
left_join(
ridings_2003 %>% st_set_geometry(NULL) %>% mutate(riding = str_to_upper(riding_label))
) %>%
filter(is.na(riding_label))
View(ridings_check_all)
View(ridings_check_2003)
use_data_raw("results")
View(ridings_check_2015)
ridings_check_2003 %>%
left_join(
ridings_2003 %>% st_set_geometry(NULL) %>% mutate(riding = str_to_upper(riding_label))
) %>%
filter(is.na(riding_label)) %>% View()
ridings_check_2003 %>%
mutate(riding = str_to_upper(riding)) %>%
left_join(
ridings_2003 %>% st_set_geometry(NULL) %>% mutate(riding = str_to_upper(riding_label))
) %>%
filter(is.na(riding_label)) %>% View()
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding = riding_label %>%
stringi::stri_enc_toascii() %>%
str_to_lower()
)
ridings_2003 %>% st_set_geometry(NULL) %>% View()
ridings_2003 %>% st_set_geometry(NULL) %>% filter(str_detect(riding, " "))
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding = riding_label %>%
stringi::stri_enc_toascii() %>%
str_to_lower() %>%
str_replace_all("\\.? ", "_")
)
ridings_2003 %>% st_set_geometry(NULL) %>% filter(str_detect(riding, " "))
ridings_2003 %>% st_set_geometry(NULL) %>% View()
stringi::stri_trans_general("Zażółć gęślą jaźń", "Latin-ASCII")
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding = riding_label %>%
stringi::stri_trans_general("Latin-ASCII") %>%
str_to_lower() %>%
str_replace_all("\\.? ", "_")
)
ridings_2003 %>% st_set_geometry(NULL) %>% View()
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding = riding_label %>%
stringi::stri_trans_general("Latin-ASCII") %>%
str_to_lower() %>%
str_replace_all("\\.? ", "_") %>%
str_remove_all("[^a-z_-]")
)
ridings_2003 %>% st_set_geometry(NULL) %>% View()
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding_label = riding_label %>%
# one typo
str_replace("¿", "--"),
riding = riding_label %>%
stringi::stri_trans_general("Latin-ASCII") %>%
str_to_lower() %>%
str_replace_all("\\.? ", "_") %>%
str_remove_all("[^a-z_-]")
)
View(ridings_2003)
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding_label = riding_label %>%
# one typo
str_replace("¿", "--"),
riding = riding_label %>%
stringi::stri_trans_general("Latin-ASCII") %>%
str_to_lower() %>%
str_replace_all("\\.? ", "_") %>%
str_remove_all("[^a-z_-]")
)
ridings_2003 %>% st_set_geometry(NULL) %>% View()
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding_label = riding_label %>%
# one typo
str_replace_all("¿", "--"),
riding = riding_label %>%
stringi::stri_trans_general("Latin-ASCII") %>%
str_to_lower() %>%
str_replace_all("\\.? ", "_") %>%
str_remove_all("[^a-z_-]")
)
ridings_2003 %>% st_set_geometry(NULL) %>% View()
sanitize_riding <- . %>%
stringi::stri_trans_general("Latin-ASCII") %>%
str_to_lower() %>%
str_replace_all("\\.? ", "_") %>%
str_remove_all("[^a-z_-]")
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding_label = riding_label %>%
# one typo
str_replace_all("¿", "--"),
riding = sanitize_riding(riding_label)
)
ridings_check_2003 <- ridings_check_all %>%
filter(lubridate::year(election_date) > 2004, lubridate::year(election_date) < 2013)
ridings_check_2003 %>%
mutate(riding = sanitize_riding(riding)) %>%
left_join(
ridings_2003 %>% st_set_geometry(NULL)
) %>%
filter(is.na(riding_label))
ridings_2003 %>%
st_set_geometry(NULL) %>%
anti_join(ridings_check_2003 %>% mutate(riding = sanitize_riding(riding)))
ridings_2003 %>%
st_set_geometry(NULL) %>%
anti_join(ridings_check_2003 %>% mutate(riding = sanitize_riding(riding)))
ridings_check_2003 <- ridings_check_all %>%
filter(lubridate::year(election_date) == 2008)
ridings_2003 %>%
st_set_geometry(NULL) %>%
anti_join(ridings_check_2003 %>% mutate(riding = sanitize_riding(riding)))
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding_label = riding_label %>%
# two typos
str_replace_all("¿", "--") %>%
str_replace("Vaudreuil-Soulanges", "Vaudreuil--Soulanges"),
riding = sanitize_riding(riding_label)
)
ridings_check_2003 <- ridings_check_all %>%
filter(lubridate::year(election_date) == 2008)
ridings_2003 %>%
st_set_geometry(NULL) %>%
anti_join(ridings_check_2003 %>% mutate(riding = sanitize_riding(riding)))
results <- bind_rows(
results_historical,
results_2011_2015
) %>%
mutate(
riding = sanitize_riding(riding)
)
View(results)
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding_label = riding_label %>%
# two typos
str_replace_all("¿", "--") %>%
str_replace("Vaudreuil-Soulanges", "Vaudreuil--Soulanges") %>%
str_replace("Northwest Territories", "Western Arctic"),
riding = sanitize_riding(riding_label)
)
ridings_2015
ridings_2015 %>%
select(province_code = PROVCODE, riding_label = ENNAME) %>%
mutate(riding_label = sanitize_riding(riding_label))
ridings_2015 %>%
select(province_code = PROVCODE, riding_label = ENNAME) %>%
left_join(provinces, by = "province_code") %>%
mutate(riding_label = sanitize_riding(riding_label))
ridings_2015_raw <- read_sf("data-raw/boundaries_2015/FED_CA_2_2_ENG.shp")
ridings_2015_raw %>%
select(province_code = PROVCODE, riding_label = ENNAME) %>%
left_join(provinces, by = "province_code") %>%
mutate(riding_label = sanitize_riding(riding_label))
ridings_2015_raw %>%
select(province_code = PROVCODE, riding_label = ENNAME) %>%
left_join(provinces, by = "province_code") %>%
mutate(riding_label = sanitize_riding(riding_label))
ridings_2015_raw %>%
select(province_code = PROVCODE, riding_label = ENNAME) %>%
left_join(provinces, by = "province_code") %>%
mutate(riding = sanitize_riding(riding_label))
ridings_2015 <- ridings_2015_raw %>%
select(province_code = PROVCODE, riding_label = ENNAME) %>%
left_join(provinces, by = "province_code") %>%
mutate(riding = sanitize_riding(riding_label))
ridings_check_2015 <- ridings_check_all %>%
filter(lubridate::year(election_date) == 2015)
ridings_2015 %>%
st_set_geometry(NULL) %>%
anti_join(ridings_check_2015)
ridings_2015 %>%
st_set_geometry(NULL) %>%
anti_join(ridings_check_2015 %>% mutate(riding = sanitize_riding(riding)))
ridings_2015 %>%
st_set_geometry(NULL) %>%
anti_join(ridings_check_2015 %>% mutate(riding = sanitize_riding(paste0(riding, "a"))))
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding_label = riding_label %>%
# two typos
str_replace_all("¿", "--") %>%
str_replace("Vaudreuil-Soulanges", "Vaudreuil--Soulanges") %>%
str_replace("Northwest Territories", "Western Arctic"),
riding = sanitize_riding(riding_label),
riding_id = sprintf("%0.3d", 1:n())
)
ridings_2003
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding_label = riding_label %>%
# two typos
str_replace_all("¿", "--") %>%
str_replace("Vaudreuil-Soulanges", "Vaudreuil--Soulanges") %>%
str_replace("Northwest Territories", "Western Arctic"),
riding = sanitize_riding(riding_label),
riding_id = sprintf("2003_%0.3d", 1:n())
)
ridings_2003
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding_label = riding_label %>%
# two typos
str_replace_all("¿", "--") %>%
str_replace("Vaudreuil-Soulanges", "Vaudreuil--Soulanges") %>%
str_replace("Northwest Territories", "Western Arctic"),
riding = sanitize_riding(riding_label),
riding_id = sprintf("2003_%0.3d", 1:n())
) %>%
rename(geometry = Shape)
ridings_2003
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding_label = riding_label %>%
# two typos
str_replace_all("¿", "--") %>%
str_replace("Vaudreuil-Soulanges", "Vaudreuil--Soulanges") %>%
str_replace("Northwest Territories", "Western Arctic"),
riding = sanitize_riding(riding_label),
riding_id = sprintf("2003_%0.3d", 1:n())
) %>%
select(everything(), geometry = Shape)
ridings_2003 <- ridings_2003_raw %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding_label = riding_label %>%
# two typos
str_replace_all("¿", "--") %>%
str_replace("Vaudreuil-Soulanges", "Vaudreuil--Soulanges") %>%
str_replace("Northwest Territories", "Western Arctic"),
riding = sanitize_riding(riding_label),
riding_id = sprintf("2003_%0.3d", 1:n())
) %>%
rename(geometry = Shape) %>%
select(everything(), geometry)
ridings_2015 <- ridings_2015_raw %>%
select(province_code = PROVCODE, riding_label = ENNAME) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding = sanitize_riding(riding_label),
riding_id = sprintf("2003_%0.3d", 1:n())
)
ridings_2015
ridings_2015 <- ridings_2015_raw %>%
select(province_code = PROVCODE, riding_label = ENNAME) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding = sanitize_riding(riding_label),
riding_id = sprintf("2003_%0.3d", 1:n())
) %>%
select(everything(), geometry)
ridings_2015
ridings_2015 <- ridings_2015_raw %>%
select(province_code = PROVCODE, riding_label = ENNAME) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding = sanitize_riding(riding_label),
riding_id = sprintf("2003_%0.3d", 1:n())
) %>%
select(everything(), geometry)
ridings_2015
ridings_2003 <- ridings_2003_raw %>%
st_transform(3979) %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding_label = riding_label %>%
# two typos
str_replace_all("¿", "--") %>%
str_replace("Vaudreuil-Soulanges", "Vaudreuil--Soulanges") %>%
str_replace("Northwest Territories", "Western Arctic"),
riding = sanitize_riding(riding_label),
geo_id = sprintf("2003_%0.3d", 1:n())
) %>%
rename(geometry = Shape) %>%
select(riding, riding_label, province, geo_id, geometry)
ridings_2003
ridings_2015 <- ridings_2015_raw %>%
st_transform(3979) %>%
select(province_code = PROVCODE, riding_label = ENNAME) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding = sanitize_riding(riding_label),
riding_id = sprintf("2003_%0.3d", 1:n())
) %>%
select(riding, riding_label, province, geo_id, geometry)
ridings_2015 <- ridings_2015_raw %>%
st_transform(3979) %>%
select(province_code = PROVCODE, riding_label = ENNAME) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding = sanitize_riding(riding_label),
geo_id = sprintf("2015_%0.3d", 1:n())
) %>%
select(riding, riding_label, province, geo_id, geometry)
ridings_2015
ridings_2003 <- ridings_2003_raw %>%
st_transform(3979) %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding_label = riding_label %>%
# two typos
str_replace_all("¿", "--") %>%
str_replace("Vaudreuil-Soulanges", "Vaudreuil--Soulanges") %>%
str_replace("Northwest Territories", "Western Arctic"),
riding = sanitize_riding(riding_label)
) %>%
group_by(province_code) %>%
mutate(geo_id = sprintf("2003_%s_%0.3d", province_code, 1:n())) %>%
ungroup() %>%
rename(geometry = Shape) %>%
select(riding, riding_label, province, geo_id, geometry)
ridings_2015 <- ridings_2015_raw %>%
st_transform(3979) %>%
select(province_code = PROVCODE, riding_label = ENNAME) %>%
left_join(provinces, by = "province_code") %>%
mutate(riding = sanitize_riding(riding_label)) %>%
group_by(province_code) %>%
mutate(geo_id = sprintf("2003_%s_%0.3d", province_code, 1:n())) %>%
ungroup() %>%
select(riding, riding_label, province, geo_id, geometry)
ridings_2003
ridings_2015 <- ridings_2015_raw %>%
st_transform(3979) %>%
select(province_code = PROVCODE, riding_label = ENNAME) %>%
left_join(provinces, by = "province_code") %>%
mutate(riding = sanitize_riding(riding_label)) %>%
group_by(province_code) %>%
mutate(geo_id = sprintf("2015_%s_%0.3d", province_code, 1:n())) %>%
ungroup() %>%
select(riding, riding_label, province, geo_id, geometry)
ridings_2015
results %>% filter(lubridate::year(election_date) == 2004)
boundaries <- rbind(boundaries_2003, boundaries_2015)
boundaries_2003_raw <- read_sf("data-raw/boundaries_2003/federal_electoral_districts_boundaries_2003_en.gdb/")
boundaries_2015_raw <- read_sf("data-raw/boundaries_2015/FED_CA_2_2_ENG.shp")
boundaries_2003 <- boundaries_2003_raw %>%
st_transform(3979) %>%
select(province_code = provcode, riding_label = name) %>%
left_join(provinces, by = "province_code") %>%
mutate(
riding_label = riding_label %>%
# two typos
str_replace_all("¿", "--") %>%
str_replace("Vaudreuil-Soulanges", "Vaudreuil--Soulanges") %>%
str_replace("Northwest Territories", "Western Arctic"),
riding = sanitize_riding(riding_label)
) %>%
group_by(province_code) %>%
mutate(geo_id = sprintf("2003_%s_%0.3d", province_code, 1:n())) %>%
ungroup() %>%
rename(geometry = Shape) %>%
select(riding, riding_label, province, geo_id, geometry)
boundaries_2015 <- boundaries_2015_raw %>%
st_transform(3979) %>%
select(province_code = PROVCODE, riding_label = ENNAME) %>%
left_join(provinces, by = "province_code") %>%
mutate(riding = sanitize_riding(riding_label)) %>%
group_by(province_code) %>%
mutate(geo_id = sprintf("2015_%s_%0.3d", province_code, 1:n())) %>%
ungroup() %>%
select(riding, riding_label, province, geo_id, geometry)
boundaries <- rbind(boundaries_2003, boundaries_2015)
usethis::use_data(boundaries, overwrite = TRUE)
boundaries %>%
st_simplify(dTolerance = 100) %>%
leaflet::leaflet() %>%
leaflet::addPolygons()
boundaries %>%
st_simplify(dTolerance = 100) %>%
st_transform(4326) %>%
leaflet::leaflet() %>%
leaflet::addPolygons()
?st_simplify
boundaries %>%
st_simplify(dTolerance = 100, preserveTopology = TRUE) %>%
st_transform(4326) %>%
leaflet::leaflet() %>%
leaflet::addPolygons()
boundaries %>%
st_simplify(dTolerance = 100, preserveTopology = TRUE) %>%
st_transform(4326) %>%
leaflet::leaflet() %>%
leaflet::addPolygons(label = ~riding_label)
boundaries %>%
st_simplify(dTolerance = 100, preserveTopology = TRUE) %>%
st_transform(4326) %>%
leaflet::leaflet() %>%
leaflet::addTiles() %>%
leaflet::addPolygons(label = ~riding_label)
boundaries %>%
st_simplify(dTolerance = 100) %>%
st_transform(4326) %>%
leaflet::leaflet() %>%
leaflet::addTiles() %>%
leaflet::addPolygons(label = ~riding_label)
st_simplify(dTolerance = 100) %>%
st_transform(4326) %>%
leaflet::leaflet() %>%
leaflet::addTiles() %>%
leaflet::addPolygons(label = ~riding_label)
boundaries %>%
filter(str_detect(geo_id, "^2015")) %>%
st_simplify(dTolerance = 100) %>%
st_transform(4326) %>%
leaflet::leaflet() %>%
leaflet::addTiles() %>%
leaflet::addPolygons(label = ~riding_label)
boundaries %>%
filter(str_detect(geo_id, "^2003")) %>%
st_simplify(dTolerance = 100) %>%
st_transform(4326) %>%
leaflet::leaflet() %>%
leaflet::addTiles() %>%
leaflet::addPolygons(label = ~riding_label)
boundaries %>%
filter(str_detect(geo_id, "^2003")) %>%
st_simplify(dTolerance = 100, preserveTopology = TRUE) %>%
st_transform(4326) %>%
leaflet::leaflet() %>%
leaflet::addTiles() %>%
leaflet::addPolygons(label = ~riding_label)
boundaries <- rbind(boundaries_2003, boundaries_2015) %>%
st_simplify(dTolerance = 100, preserveTopology = TRUE) %>%
st_transform(4326)
usethis::use_data(boundaries, overwrite = TRUE)
unlink("data-raw/boundaries_2015.zip")
unlink("data-raw/boundaries_2015/", recursive = TRUE)
unlink("data-raw/boundaries_2003.zip")
unlink("data-raw/boundaries_2003/", recursive = TRUE)
unlink("data-raw/results_2011.zip")
unlink("data-raw/results_2011/", recursive = TRUE)
